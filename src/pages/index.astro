---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SocialLinks from '../components/SocialLinks.astro';
import PostCard from '../components/PostCard.astro';
import ProjectCard from '../components/ProjectCard.astro';
import BuildingNow from '../components/BuildingNow.astro';
import ContributionGrid from '../components/ContributionGrid.astro';
import TimelineRail from '../components/TimelineRail.astro';
import { Image } from 'astro:assets';
import { siteConfig } from '../data/site';
import { projects } from '../data/projects';
import headshotImg from '../assets/images/LI_headshot.jpeg';
import { fetchContributionCalendar, fetchRecentlyActiveRepos, fetchRepoDetails } from '../lib/github';

const recentPosts = (await getCollection('writing'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 4);

const featuredProjects = projects.filter(p => p.featured);

const githubUrls = projects
  .map(p => p.githubUrl)
  .filter((url): url is string => !!url);

const [calendar, recentRepos, repoDetails] = await Promise.all([
  fetchContributionCalendar('benjaminshoemaker'),
  fetchRecentlyActiveRepos('benjaminshoemaker', 5),
  fetchRepoDetails('benjaminshoemaker', githubUrls),
]);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'ProfilePage',
  mainEntity: {
    '@type': 'Person',
    name: siteConfig.author.name,
    url: siteConfig.url,
    sameAs: [
      siteConfig.social.github,
      siteConfig.social.linkedin,
      siteConfig.social.twitter,
    ],
  },
};
---

<BaseLayout title={siteConfig.title} description={siteConfig.description} jsonLd={jsonLd}>
  {/* Hero + Content + Timeline Rail */}
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="lg:flex lg:gap-12">
      {/* Main column */}
      <div class="flex-1 min-w-0">
        {/* Hero */}
        <section class="py-12 sm:py-16">
          <div class="flex items-start gap-6 mb-6">
            <Image
              src={headshotImg}
              alt="Ben Shoemaker"
              class="hidden sm:block w-20 h-20 rounded-full object-cover shrink-0 mt-1"
              width={80}
              height={80}
            />
            <h1 class="text-4xl sm:text-5xl font-bold text-text-primary" style="text-wrap: balance;">
              Product leader. Builder.<br class="hidden sm:block" />
              Technical co-founder.
            </h1>
          </div>
          <div class="max-w-prose mb-8 space-y-4">
            <p class="text-lg sm:text-xl leading-relaxed text-text-body">
              12 years at Indeed building company-wide metrics and scaling products 6x. Now I ship AI-powered products myself. I think we're seeing a new role emerge: product intuition plus technical depth. I write about it and build it in the open.
            </p>
            <p class="text-base leading-relaxed text-text-muted">
              Selectively taking on consulting, advisory, and full-time opportunities — also open to interesting conversations.
            </p>
          </div>
          <div class="flex flex-col sm:flex-row gap-3 mb-8">
            <a
              href={`mailto:${siteConfig.author.email}`}
              class="inline-flex items-center justify-center px-6 py-3 border border-border bg-surface-raised text-text-primary font-medium rounded-lg hover:bg-white transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus"
            >
              Get in touch
            </a>
            <a
              href="/services"
              class="inline-flex items-center justify-center px-6 py-3 bg-accent text-white font-medium rounded-lg hover:bg-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus"
            >
              Work with me
            </a>
          </div>
          <SocialLinks />
        </section>

        {/* Recent Writing */}
        <section class="pt-4 pb-12 fade-up">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-text-primary">Recent Writing</h2>
            <a href="/writing" class="text-sm text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
              View all &rarr;
            </a>
          </div>
          {recentPosts.length > 0 ? (
            <div class="space-y-4">
              {recentPosts.map(post => (
                <PostCard
                  title={post.data.title}
                  date={post.data.date}
                  type={post.data.type}
                  tags={post.data.tags}
                  description={post.data.description}
                  slug={post.id}
                />
              ))}
            </div>
          ) : (
            <p class="text-text-muted">Posts coming soon.</p>
          )}
        </section>

        {/* Featured Projects */}
        <section class="py-12 border-t border-border fade-up">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-text-primary">Featured Projects</h2>
            <a href="/projects" class="text-sm text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
              View all &rarr;
            </a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {featuredProjects.map(project => {
              const details = project.githubUrl ? repoDetails?.get(project.githubUrl) : undefined;
              return (
                <ProjectCard
                  name={project.name}
                  description={project.description}
                  techStack={project.techStack}
                  githubUrl={project.githubUrl}
                  liveUrl={project.liveUrl}
                  stars={details?.stargazerCount}
                  lastUpdated={details?.pushedAt}
                />
              );
            })}
          </div>
        </section>
      </div>

      {/* Right rail — timeline, starts at hero height */}
      <aside class="mt-12 lg:mt-0 lg:w-56 lg:shrink-0 lg:pt-16 lg:sticky lg:top-24 lg:self-start">
        <TimelineRail projects={projects} repoDetails={repoDetails} />
      </aside>
    </div>
  </div>

  {/* Activity — Building Now + Contribution Grid */}
  <section class="bg-surface-muted fade-up">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-text-primary">Activity</h2>
      <a href={siteConfig.social.github} target="_blank" rel="noopener noreferrer" class="text-sm text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
        GitHub &rarr;
      </a>
    </div>
    {recentRepos && recentRepos.length > 0 && (
      <div class="mb-10">
        <BuildingNow repos={recentRepos} />
      </div>
    )}
    {calendar && (
      <div>
        <ContributionGrid calendar={calendar} />
      </div>
    )}
    </div>
  </section>

  {/* CTA — Get in Touch */}
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 fade-up">
    <div class="rounded-2xl bg-accent-light border border-accent/20 p-6 sm:p-8">
      <h2 class="text-xl font-semibold text-text-primary mb-4">Get in Touch</h2>
      <p class="text-text-body mb-6">
        I'm building my own ventures and selectively taking on consulting and advisory work. Open to the right opportunity — full-time, fractional, or partnership — with teams doing interesting work in AI, data, or dev tooling.
      </p>
      <div class="flex flex-col sm:flex-row gap-4">
        <a
          href={`mailto:${siteConfig.author.email}`}
          class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-accent text-white font-medium rounded-lg hover:bg-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
            <polyline points="22,6 12,13 2,6" />
          </svg>
          Send an Email
        </a>
        <a
          href={siteConfig.author.calendarUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center justify-center gap-2 px-6 py-3 border border-border bg-surface-raised text-text-primary font-medium rounded-lg hover:bg-white transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
          Book a Call
        </a>
      </div>
    </div>
  </section>

  <script>
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.1 }
    );
    document.querySelectorAll('.fade-up').forEach((el) => observer.observe(el));
  </script>
</BaseLayout>
