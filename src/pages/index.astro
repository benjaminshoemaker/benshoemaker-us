---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import SocialLinks from '../components/SocialLinks.astro';
import PostCard from '../components/PostCard.astro';
import ProjectCard from '../components/ProjectCard.astro';
import BuildingNow from '../components/BuildingNow.astro';
import ContributionGrid from '../components/ContributionGrid.astro';
import TimelineRail from '../components/TimelineRail.astro';
import { siteConfig } from '../data/site';
import { projects } from '../data/projects';
import { fetchContributionCalendar, fetchRecentlyActiveRepos, fetchRepoDetails } from '../lib/github';

const recentPosts = (await getCollection('writing'))
  .filter(post => !post.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 4);

const featuredProjects = projects.filter(p => p.featured);

const githubUrls = projects
  .map(p => p.githubUrl)
  .filter((url): url is string => !!url);

const [calendar, recentRepos, repoDetails] = await Promise.all([
  fetchContributionCalendar('benjaminshoemaker'),
  fetchRecentlyActiveRepos('benjaminshoemaker', 5),
  fetchRepoDetails('benjaminshoemaker', githubUrls),
]);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'ProfilePage',
  mainEntity: {
    '@type': 'Person',
    name: siteConfig.author.name,
    url: siteConfig.url,
    sameAs: [
      siteConfig.social.github,
      siteConfig.social.linkedin,
      siteConfig.social.twitter,
    ],
  },
};
---

<BaseLayout title={siteConfig.title} description={siteConfig.description} jsonLd={jsonLd}>
  {/* Hero + Content + Timeline Rail */}
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="lg:flex lg:gap-12">
      {/* Main column */}
      <div class="flex-1 min-w-0">
        {/* Hero */}
        <section class="py-16 sm:py-24">
          <h1 class="text-4xl sm:text-5xl font-bold text-text-primary mb-6">
            Product leader. Builder.<br class="hidden sm:block" />
            Technical co-founder.
          </h1>
          <div class="max-w-prose mb-8 space-y-4">
            <p class="text-xl text-text-body">
              I spent 12 years at Indeed creating company-wide success metrics used by executives and the board, and scaling SMB hiring products through analytics-driven experimentation.
            </p>
            <p class="text-xl text-text-body">
              AI tools changed what's possible. Now I build products myself — a spec generator with 4,000+ users, a PropTech platform from scratch. Product leaders can ship now, not just specify.
            </p>
            <p class="text-xl text-text-body">
              I think we're seeing a new role emerge — product intuition plus technical depth. Software development is changing. I'm figuring out what that looks like. I write about it and build it in the open.
            </p>
          </div>
          <SocialLinks />
        </section>

        {/* Recent Writing */}
        <section class="py-16 border-t border-border">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-text-primary">Recent Writing</h2>
            <a href="/writing" class="text-sm text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
              View all &rarr;
            </a>
          </div>
          {recentPosts.length > 0 ? (
            <div class="space-y-3">
              {recentPosts.map(post => (
                <PostCard
                  title={post.data.title}
                  date={post.data.date}
                  type={post.data.type}
                  tags={post.data.tags}
                  description={post.data.description}
                  slug={post.id}
                />
              ))}
            </div>
          ) : (
            <p class="text-text-muted">Posts coming soon.</p>
          )}
        </section>

        {/* Featured Projects */}
        <section class="py-16 border-t border-border">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-bold text-text-primary">Featured Projects</h2>
            <a href="/projects" class="text-sm text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
              View all &rarr;
            </a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {featuredProjects.map(project => {
              const details = project.githubUrl ? repoDetails?.get(project.githubUrl) : undefined;
              return (
                <ProjectCard
                  name={project.name}
                  description={project.description}
                  techStack={project.techStack}
                  githubUrl={project.githubUrl}
                  liveUrl={project.liveUrl}
                  stars={details?.stargazerCount}
                  lastUpdated={details?.pushedAt}
                />
              );
            })}
          </div>
        </section>
      </div>

      {/* Right rail — timeline, starts at hero height */}
      <aside class="mt-12 lg:mt-0 lg:w-56 lg:shrink-0 lg:pt-24 lg:sticky lg:top-24 lg:self-start">
        <TimelineRail projects={projects} repoDetails={repoDetails} />
      </aside>
    </div>
  </div>

  {/* Activity — Building Now + Contribution Grid */}
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 border-t border-border">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-text-primary">Activity</h2>
      <a href={siteConfig.social.github} target="_blank" rel="noopener noreferrer" class="text-sm text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
        GitHub &rarr;
      </a>
    </div>
    {recentRepos && recentRepos.length > 0 && (
      <div class="mb-10">
        <BuildingNow repos={recentRepos} />
      </div>
    )}
    {calendar && (
      <div>
        <ContributionGrid calendar={calendar} />
      </div>
    )}
  </section>

  {/* CTA */}
  <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 border-t border-border">
    <p class="text-text-muted">
      Looking for help with AI-assisted development?
      <a href="/services" class="text-accent hover:text-accent-hover transition-colors focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-focus">
        Check out my services
      </a>.
    </p>
  </section>
</BaseLayout>
