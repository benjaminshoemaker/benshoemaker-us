---
import BaseLayout from '../layouts/BaseLayout.astro';
import ProjectCard from '../components/ProjectCard.astro';
import GitHubStats from '../components/GitHubStats.astro';
import ProjectTimeline from '../components/ProjectTimeline.astro';
import { projects } from '../data/projects';
import { fetchGitHubStats, fetchRepoDetails } from '../lib/github';

const githubUrls = projects
  .map(p => p.githubUrl)
  .filter((url): url is string => !!url);

const [githubStats, repoDetails] = await Promise.all([
  fetchGitHubStats('benjaminshoemaker'),
  fetchRepoDetails('benjaminshoemaker', githubUrls),
]);

const timelineProjects = projects
  .filter(p => p.startDate)
  .sort((a, b) => new Date(b.startDate!).getTime() - new Date(a.startDate!).getTime());
---

<BaseLayout title="Projects" description="A curated selection of projects I've built, including AI coding tools and analytics platforms.">
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <header class="mb-12">
        <h1 class="text-3xl font-bold text-text-primary mb-4">Projects</h1>
        <p class="text-lg text-text-muted max-w-prose">
          A curated selection of projects I've built.
        </p>
      </header>
    </div>
  </section>

  <section class="py-12 bg-surface-muted">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        {projects.map(project => {
          const details = project.githubUrl ? repoDetails?.get(project.githubUrl) : undefined;
          return (
            <ProjectCard
              name={project.name}
              description={project.description}
              techStack={project.techStack}
              githubUrl={project.githubUrl}
              liveUrl={project.liveUrl}
              stars={details?.stargazerCount}
              lastUpdated={details?.pushedAt}
            />
          );
        })}
      </div>
    </div>
  </section>

  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <GitHubStats stats={githubStats} />
    </div>
  </section>

  {timelineProjects.length > 0 && (
    <section class="py-12 bg-surface-muted">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl font-bold text-text-primary mb-8">Project Timeline</h2>
        <ProjectTimeline projects={timelineProjects} />
      </div>
    </section>
  )}
</BaseLayout>
